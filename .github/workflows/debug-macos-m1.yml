name: Debug macOS M1 (tmate SSH)

on:
  workflow_dispatch:

jobs:
  debug-m1:
    runs-on: macos-14  # Apple Silicon (M1/M2)
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: System info
        run: |
          echo "=== Machine info ==="
          uname -a
          sysctl -n machdep.cpu.brand_string
          sw_vers
          echo "=== Disk space ==="
          df -h /
          echo "=== Memory ==="
          sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin

      - name: Install dependencies
        run: |
          brew install ffmpeg wget

      - name: Install frontend dependencies
        working-directory: apps/screenpipe-app-tauri
        run: bun install

      - name: Run pre_build.js
        env:
          SKIP_SCREENPIPE_SETUP: true
        working-directory: apps/screenpipe-app-tauri
        run: bun ./scripts/pre_build.js

      - name: Use production config
        run: cp apps/screenpipe-app-tauri/src-tauri/tauri.prod.conf.json apps/screenpipe-app-tauri/src-tauri/tauri.conf.json

      - name: Build the app
        working-directory: apps/screenpipe-app-tauri
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          bunx tauri build --target aarch64-apple-darwin --features metal,official-build 2>&1 | tee /tmp/build.log || true
          echo "=== Build artifacts ==="
          find src-tauri/target -name "*.dmg" -o -name "*.app" -type d 2>/dev/null | head -20

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
        timeout-minutes: 90
