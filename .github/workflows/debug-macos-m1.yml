name: Debug macOS M1 (build + crash diagnostics)

on:
  workflow_dispatch:

jobs:
  debug-m1:
    runs-on: macos-14  # Apple Silicon (M1/M2)
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: System info
        run: |
          echo "=== Machine info ==="
          uname -a
          sysctl -n machdep.cpu.brand_string
          sw_vers
          echo "=== Disk space ==="
          df -h /
          echo "=== Memory ==="
          sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin

      - name: Install dependencies
        run: brew install ffmpeg wget

      - name: Install frontend dependencies
        working-directory: apps/screenpipe-app-tauri
        run: bun install

      - name: Run pre_build.js
        env:
          SKIP_SCREENPIPE_SETUP: true
        working-directory: apps/screenpipe-app-tauri
        run: bun ./scripts/pre_build.js

      - name: Use production config
        run: cp apps/screenpipe-app-tauri/src-tauri/tauri.prod.conf.json apps/screenpipe-app-tauri/src-tauri/tauri.conf.json

      - name: Build the app
        working-directory: apps/screenpipe-app-tauri
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
          CFLAGS: "-mmacosx-version-min=10.15 -mcpu=apple-m1 -U__ARM_FEATURE_MATMUL_INT8"
          CXXFLAGS: "-mmacosx-version-min=10.15 -mcpu=apple-m1 -U__ARM_FEATURE_MATMUL_INT8"
        run: |
          bunx tauri build --target aarch64-apple-darwin --features metal,official-build 2>&1 | tee /tmp/build.log
          echo "=== Build artifacts ==="
          find src-tauri/target -name "*.dmg" -o -name "*.app" -type d 2>/dev/null | head -20

      - name: Check signing of built app
        if: always()
        run: |
          echo "=== Checking app signing ==="
          APP=$(find apps/screenpipe-app-tauri/src-tauri/target -name "*.app" -type d 2>/dev/null | head -1)
          if [ -n "$APP" ]; then
            echo "Found app: $APP"
            codesign -dvv "$APP" 2>&1 || echo "NOT SIGNED"
            echo "=== Gatekeeper check ==="
            spctl --assess --type execute --verbose "$APP" 2>&1 || echo "GATEKEEPER REJECTED"
          else
            echo "No .app found"
          fi

          echo "=== Checking CLI binary ==="
          CLI=$(find apps/screenpipe-app-tauri/src-tauri/target -name "screenpipe" -type f -not -path "*/deps/*" 2>/dev/null | head -1)
          if [ -n "$CLI" ]; then
            echo "Found CLI: $CLI"
            codesign -dvv "$CLI" 2>&1 || echo "NOT SIGNED"
          fi

      - name: Try running the app binary
        if: always()
        run: |
          echo "=== Attempting to run screenpipe binary ==="
          BIN=$(find apps/screenpipe-app-tauri/src-tauri/target/aarch64-apple-darwin/release -name "screenpipe-app" -type f 2>/dev/null | head -1)
          if [ -n "$BIN" ]; then
            echo "Running: $BIN"
            timeout 15 "$BIN" 2>&1 || echo "Exit code: $?"
          else
            echo "No binary found, checking what exists:"
            ls -la apps/screenpipe-app-tauri/src-tauri/target/aarch64-apple-darwin/release/ 2>/dev/null | head -20
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: m1-debug-logs
          path: |
            /tmp/build.log
          retention-days: 3
